<script setup lang="ts">
import { computed, defineProps, onMounted, ref } from 'vue'
import type { ActivityWithDetails } from '../../types'
import { isAnImage } from '../../utils'
import { i18n } from '../../lang'

const props = defineProps({
  activity: {
    type: Object as () => ActivityWithDetails,
    required: true,
  },
})


const emit = defineEmits<{
  (e: 'click', activity: ActivityWithDetails): void
}>()

const loading = ref<boolean>(true)
const image = computed(() => {
  const image = props.activity.activity.image.find((img) => isAnImage(img))
  return image ?? ''
})

const addressFormatted = computed(() => {
  const location = props.activity.activity.locations.find((loc) => loc)
  return `${location?.address}, ${location?.province}`
})


const onClickCard = () => {
  emit('click', props.activity)
}

onMounted(() => {
  const image = document.querySelector('img')

  if (image) {
    image.addEventListener('load', () => {
      console.log('Image loaded', props.activity.title)
      loading.value = false
    })
  }
})
</script>
<template>
  <div v-if="props.activity" :key="props.activity.id"
    :class="['group text-sm transition-opacity duration-150', loading ? 'animate-pulse hover:cursor-progress' : 'hover:cursor-pointer']"
    @click="onClickCard">
    <div
      :class="['aspect-h-1 aspect-w-1 w-full overflow-hidden rounded-md bg-gray-100 transition-all duration-150 group-hover:opacity-75']">

      <div class="">
        <img :src="image" :alt="props.activity.title"
          :class="['h-full w-full object-cover object-center transition duration-300', loading ? 'opacity-0' : 'opacity-100']" />
      </div>
    </div>
    <div class="flex items-center justify-between mt-3">
      <h3 class="font-bold text-lg text-gray-900 line-clamp-1">{{ props.activity.title }}</h3>
      <span data-test="participants">
        <svg v-if="activity.activity.participants === 1" data-test="one" width="24" height="16" viewBox="0 0 24 16"
          fill="none" xmlns="http://www.w3.org/2000/svg">
          <g clip-path="url(#clip0_4343_349)">
            <path
              d="M3.33792 4.66668C3.33792 3.94148 3.543 3.23257 3.92722 2.62959C4.31144 2.02661 4.85755 1.55665 5.49649 1.27912C6.13542 1.0016 6.83849 0.928991 7.51678 1.07047C8.19507 1.21195 8.81812 1.56117 9.30714 2.07396C9.79616 2.58675 10.1292 3.24009 10.2641 3.95135C10.399 4.66262 10.3298 5.39986 10.0651 6.06986C9.80047 6.73985 9.35229 7.31251 8.77727 7.7154C8.20224 8.1183 7.52619 8.33335 6.83461 8.33335C7.58074 8.33531 8.32158 8.46479 9.02799 8.71668C9.88314 8.20875 10.5539 7.41828 10.9356 6.4686C11.3173 5.51892 11.3885 4.46346 11.138 3.4669C10.8875 2.47035 10.3295 1.58876 9.55106 0.959705C8.77258 0.330647 7.81742 -0.010498 6.83461 -0.010498C5.85181 -0.010498 4.89664 0.330647 4.11816 0.959705C3.33968 1.58876 2.78168 2.47035 2.53122 3.4669C2.28076 4.46346 2.35193 5.51892 2.73363 6.4686C3.11533 7.41828 3.78608 8.20875 4.64123 8.71668C5.34764 8.46479 6.08848 8.33531 6.83461 8.33335C5.90723 8.33335 5.01783 7.94704 4.36208 7.25941C3.70632 6.57177 3.33792 5.63914 3.33792 4.66668Z"
              fill="#464646" />
            <path
              d="M0 15.5001C0 15.6327 0.0502364 15.7599 0.139658 15.8537C0.229079 15.9475 0.35036 16.0001 0.476821 16.0001C0.603282 16.0001 0.724563 15.9475 0.813985 15.8537C0.903406 15.7599 0.953642 15.6327 0.953642 15.5001C0.955745 13.8653 1.576 12.2981 2.67841 11.1421C3.78082 9.98608 5.2754 9.33567 6.83444 9.33346C6.06412 9.33533 5.30717 9.12251 4.64106 8.7168C3.29059 9.20059 2.11768 10.1141 1.28577 11.33C0.453864 12.5459 0.0043954 14.0037 0 15.5001H0Z"
              fill="#464646" />
            <path
              d="M11.5868 11.3751C11.7139 11.1835 11.8729 11.0085 12.0159 10.8335C11.2157 9.86347 10.1847 9.13313 9.02785 8.7168C8.36174 9.12251 7.60479 9.33533 6.83447 9.33346C8.39351 9.33567 9.88809 9.98608 10.9905 11.1421C12.0929 12.2981 12.7132 13.8653 12.7153 15.5001C12.7153 15.6327 12.7655 15.7599 12.8549 15.8537C12.9443 15.9475 13.0656 16.0001 13.1921 16.0001C13.3186 16.0001 13.4398 15.9475 13.5293 15.8537C13.6187 15.7599 13.6689 15.6327 13.6689 15.5001C13.6666 14.1401 13.2915 12.8095 12.5881 11.6668C12.5086 11.7835 12.4133 11.8918 12.3338 12.0085C12.1191 11.7564 11.8668 11.5425 11.5868 11.3751Z"
              fill="#464646" />
            <path
              d="M6.83449 8.33325C6.08836 8.33521 5.34752 8.46469 4.64111 8.71659C5.30798 9.12032 6.06445 9.33287 6.83449 9.33287C7.60453 9.33287 8.361 9.12032 9.02787 8.71659C8.32146 8.46469 7.58062 8.33521 6.83449 8.33325Z"
              fill="#464646" />
            <path
              d="M11.5869 11.375C11.8658 11.5373 12.118 11.7455 12.3339 11.9917C12.4134 11.875 12.5088 11.7667 12.5882 11.65C12.4142 11.36 12.2231 11.0817 12.0161 10.8167C11.873 11.0083 11.7141 11.1833 11.5869 11.375Z"
              fill="#464646" />
          </g>
          <defs>
            <clipPath id="clip0_4343_349">
              <rect width="24" height="16" fill="white" />
            </clipPath>
          </defs>
        </svg>

        <svg v-if="activity.activity.participants > 1" data-test="more-than-one" width="24" height="16"
          viewBox="0 0 24 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M3.33792 4.66668C3.33792 3.94148 3.543 3.23257 3.92722 2.62959C4.31144 2.02661 4.85755 1.55665 5.49649 1.27912C6.13542 1.0016 6.83849 0.928991 7.51678 1.07047C8.19507 1.21195 8.81812 1.56117 9.30714 2.07396C9.79616 2.58675 10.1292 3.24009 10.2641 3.95135C10.399 4.66262 10.3298 5.39986 10.0651 6.06986C9.80047 6.73985 9.35229 7.31251 8.77727 7.7154C8.20224 8.1183 7.52619 8.33335 6.83461 8.33335C7.58074 8.33531 8.32158 8.46479 9.02799 8.71668C9.88314 8.20875 10.5539 7.41828 10.9356 6.4686C11.3173 5.51892 11.3885 4.46346 11.138 3.4669C10.8875 2.47035 10.3295 1.58876 9.55106 0.959705C8.77258 0.330647 7.81742 -0.010498 6.83461 -0.010498C5.85181 -0.010498 4.89664 0.330647 4.11816 0.959705C3.33968 1.58876 2.78168 2.47035 2.53122 3.4669C2.28076 4.46346 2.35193 5.51892 2.73363 6.4686C3.11533 7.41828 3.78608 8.20875 4.64123 8.71668C5.34764 8.46479 6.08848 8.33531 6.83461 8.33335C5.90723 8.33335 5.01783 7.94704 4.36208 7.25941C3.70632 6.57177 3.33792 5.63914 3.33792 4.66668Z"
            fill="#464646" />
          <path
            d="M0 15.5001C0 15.6327 0.0502364 15.7599 0.139658 15.8537C0.229079 15.9475 0.35036 16.0001 0.476821 16.0001C0.603282 16.0001 0.724563 15.9475 0.813985 15.8537C0.903406 15.7599 0.953642 15.6327 0.953642 15.5001C0.955745 13.8653 1.576 12.2981 2.67841 11.1421C3.78082 9.98608 5.2754 9.33567 6.83444 9.33346C6.06412 9.33533 5.30717 9.12251 4.64106 8.7168C3.29059 9.20059 2.11768 10.1141 1.28577 11.33C0.453864 12.5459 0.0043954 14.0037 0 15.5001H0Z"
            fill="#464646" />
          <path
            d="M11.5868 11.3751C11.7139 11.1835 11.8729 11.0085 12.0159 10.8335C11.2157 9.86347 10.1847 9.13313 9.02785 8.7168C8.36174 9.12251 7.60479 9.33533 6.83447 9.33346C8.39351 9.33567 9.88809 9.98608 10.9905 11.1421C12.0929 12.2981 12.7132 13.8653 12.7153 15.5001C12.7153 15.6327 12.7655 15.7599 12.8549 15.8537C12.9443 15.9475 13.0656 16.0001 13.1921 16.0001C13.3186 16.0001 13.4398 15.9475 13.5293 15.8537C13.6187 15.7599 13.6689 15.6327 13.6689 15.5001C13.6666 14.1401 13.2915 12.8095 12.5881 11.6668C12.5086 11.7835 12.4133 11.8918 12.3338 12.0085C12.1191 11.7564 11.8668 11.5425 11.5868 11.3751Z"
            fill="#464646" />
          <path
            d="M6.83449 8.33325C6.08836 8.33521 5.34752 8.46469 4.64111 8.71659C5.30798 9.12032 6.06445 9.33287 6.83449 9.33287C7.60453 9.33287 8.361 9.12032 9.02787 8.71659C8.32146 8.46469 7.58062 8.33521 6.83449 8.33325Z"
            fill="#464646" />
          <path
            d="M13.669 4.66668C13.669 3.94148 13.8741 3.23257 14.2583 2.62959C14.6425 2.02661 15.1886 1.55665 15.8275 1.27912C16.4665 1.0016 17.1695 0.928991 17.8478 1.07047C18.5261 1.21195 19.1492 1.56117 19.6382 2.07396C20.1272 2.58675 20.4602 3.24009 20.5952 3.95135C20.7301 4.66262 20.6608 5.39986 20.3962 6.06986C20.1315 6.73985 19.6834 7.31251 19.1083 7.7154C18.5333 8.1183 17.8572 8.33335 17.1657 8.33335C17.9118 8.33531 18.6526 8.46479 19.359 8.71668C20.2142 8.20875 20.8849 7.41828 21.2666 6.4686C21.6483 5.51892 21.7195 4.46346 21.4691 3.4669C21.2186 2.47035 20.6606 1.58876 19.8821 0.959705C19.1036 0.330647 18.1485 -0.010498 17.1657 -0.010498C16.1829 -0.010498 15.2277 0.330647 14.4492 0.959705C13.6707 1.58876 13.1127 2.47035 12.8623 3.4669C12.6118 4.46346 12.683 5.51892 13.0647 6.4686C13.4464 7.41828 14.1171 8.20875 14.9723 8.71668C15.6787 8.46479 16.4195 8.33531 17.1657 8.33335C16.2383 8.33335 15.3489 7.94704 14.6931 7.25941C14.0374 6.57177 13.669 5.63914 13.669 4.66668Z"
            fill="#464646" />
          <path
            d="M19.3589 8.7168C18.6928 9.12251 17.9358 9.33533 17.1655 9.33346C18.7246 9.33567 20.2191 9.98608 21.3216 11.1421C22.424 12.2981 23.0442 13.8653 23.0463 15.5001C23.0463 15.6327 23.0966 15.7599 23.186 15.8537C23.2754 15.9475 23.3967 16.0001 23.5231 16.0001C23.6496 16.0001 23.7709 15.9475 23.8603 15.8537C23.9497 15.7599 24 15.6327 24 15.5001C23.9956 14.0037 23.5461 12.5459 22.7142 11.33C21.8823 10.1141 20.7094 9.20059 19.3589 8.7168Z"
            fill="#464646" />
          <path
            d="M17.1655 8.33325C16.4194 8.33521 15.6786 8.46469 14.9722 8.71659C15.639 9.12032 16.3955 9.33287 17.1655 9.33287C17.9356 9.33287 18.6921 9.12032 19.3589 8.71659C18.6525 8.46469 17.9117 8.33521 17.1655 8.33325Z"
            fill="#464646" />
          <path
            d="M12.0161 10.8335C12.2232 11.0985 12.4143 11.3768 12.5883 11.6668C13.1351 10.9423 13.8306 10.3563 14.6231 9.95231C15.4156 9.54835 16.2846 9.33683 17.1658 9.33346C16.3955 9.33533 15.6385 9.12251 14.9724 8.7168C13.8253 9.13476 12.805 9.86532 12.0161 10.8335Z"
            fill="#464646" />
          <path
            d="M11.5869 11.375C11.8658 11.5373 12.118 11.7455 12.3339 11.9917C12.4134 11.875 12.5088 11.7667 12.5882 11.65C12.4142 11.36 12.2231 11.0817 12.0161 10.8167C11.873 11.0083 11.7141 11.1833 11.5869 11.375Z"
            fill="#464646" />
        </svg>

      </span>
    </div>
    <div class="flex items-center justify-start gap-2 my-3">
      <span>
        <svg width="9" height="15" viewBox="0 0 9 15" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.49973 5.99633C3.93945 5.99633 3.46416 5.53767 3.46416 4.96031C3.46416 4.40003 3.92236 3.92474 4.49973 3.92474C5.06047 3.92474 5.53576 4.38294 5.53576 4.96031C5.53576 5.53767 5.06047 5.99633 4.49973 5.99633ZM4.49973 3.1604C3.51498 3.1604 2.7002 3.97564 2.7002 4.9604C2.7002 5.94562 3.51498 6.76086 4.49973 6.76086C5.48495 6.76086 6.29973 5.94562 6.29973 4.9604C6.29973 3.97564 5.48495 3.1604 4.49973 3.1604Z"
            fill="#FF6C5E" />
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.49975 13.0946L1.18843 6.67566C0.916837 6.1491 0.780579 5.57173 0.780579 4.96065C0.780579 2.90568 2.46233 1.22485 4.51684 1.22485C6.57134 1.22485 8.25263 2.90568 8.25263 4.96065C8.25263 5.5551 8.11684 6.13247 7.84524 6.65857L4.49975 13.0946ZM9 4.96068C9 2.48123 6.97921 0.460449 4.49977 0.460449C2.02078 0.460449 0 2.48123 0 4.96068C0 5.67384 0.169515 6.4041 0.509007 7.03227L4.16028 14.1136C4.22818 14.2494 4.36397 14.3173 4.49977 14.3173C4.63557 14.3173 4.77182 14.2323 4.83926 14.1136L6.67344 10.5729L8.50762 7.03227C8.83002 6.38701 9 5.67384 9 4.96068Z"
            fill="#FF6C5E" />
        </svg>

      </span>
      <span class="font-normal text-sm text-gray-900 line-clamp-1">{{ addressFormatted }}</span>
    </div>
    <p class=" text-gray-500 line-clamp-2">{{ props.activity.activity.description }}</p>
    <p class="mt-2 font-semibold text-lg text-gray-900">{{ props.activity.price }} {{ i18n.es.points }}
    </p>
  </div>
</template>
